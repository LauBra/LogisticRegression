prediction_pima <-
predict(log_fit, new_data = pima, type = "prob") %>%
rename(prob = .pred_pos)  %>%
dplyr::bind_cols(pima)
head(pima)
pima <- pima %>%
mutate(
class_0.3 = if_else(prob >= 0.3, 1, 0),
class_0.5 = if_else(prob >= 0.5, 1, 0),
class_0.7 = if_else(prob >= 0.7, 1, 0)
)
prediction_pima <- prediction_pima %>%
mutate(
class_0.3 = if_else(prob >= 0.3, 1, 0),
class_0.5 = if_else(prob >= 0.5, 1, 0),
class_0.7 = if_else(prob >= 0.7, 1, 0)
)
ggplot(prediction_pima, aes(x = glucose, y = prob)) +
geom_point(alpha = 0.4) +
geom_hline(yintercept = 0.3, colour = "blue", linetype = "dashed") +
geom_hline(yintercept = 0.5, colour = "red", linetype = "dashed") +
geom_hline(yintercept = 0.7, colour = "purple", linetype = "dashed") +
labs(
x = "Glucose",
y = "Predicted probability of diabetes",
title = "Predicted probabilities with threshold lines"
) +
theme_minimal()
table(True = prediction_pima$diabetes_dummy, Predicted = prediction_pima$class_0.3)
table(True = prediction_pima$diabetes_dummy, Predicted = prediction_pima$class_0.7)
threshold_compare <- tibble(
threshold = c("0.3", "0.5", "0.7"),
TP = c(
sum(prediction_pima$diabetes_dummy == 1 & prediction_pima$class_0.3 == 1),
sum(prediction_pima$diabetes_dummy == 1 & prediction_pima$class_0.5 == 1),
sum(prediction_pima$diabetes_dummy == 1 & prediction_pima$class_0.7 == 1)
),
FP = c(
sum(prediction_pima$diabetes_dummy == 0 & prediction_pima$class_0.3 == 1),
sum(prediction_pima$diabetes_dummy == 0 & prediction_pima$class_0.5 == 1),
sum(prediction_pima$diabetes_dummy == 0 & prediction_pima$class_0.7 == 1)
),
FN = c(
sum(prediction_pima$diabetes_dummy == 1 & prediction_pima$class_0.3 == 0),
sum(prediction_pima$diabetes_dummy == 1 & prediction_pima$class_0.5 == 0),
sum(prediction_pima$diabetes_dummy == 1 & prediction_pima$class_0.7 == 0)
),
TN = c(
sum(prediction_pima$diabetes_dummy == 0 & prediction_pima$class_0.3 == 0),
sum(prediction_pima$diabetes_dummy == 0 & prediction_pima$class_0.5 == 0),
sum(prediction_pima$diabetes_dummy == 0 & prediction_pima$class_0.7 == 0)
)
)
threshold_compare
prediction_pima <-
predict(log_fit, new_data = pima[,1:10], type = "prob") %>%
rename(prob = .pred_pos)  %>%
dplyr::bind_cols(pima)
prediction_pima <-
predict(log_fit, new_data = pima[1:10,], type = "prob") %>%
rename(prob = .pred_pos)  %>%
dplyr::bind_cols(pima)
prediction_pima <-
predict(log_fit, new_data = pima[1:10,], type = "prob") %>%
rename(prob = .pred_pos)  %>%
dplyr::bind_cols(pima[1:10,])
head(pima)
prediction_pima <- prediction_pima %>%
mutate(
class_0.3 = if_else(prob >= 0.3, 1, 0),
class_0.5 = if_else(prob >= 0.5, 1, 0),
class_0.7 = if_else(prob >= 0.7, 1, 0)
)
ggplot(prediction_pima, aes(x = glucose, y = prob)) +
geom_point(alpha = 0.4) +
geom_hline(yintercept = 0.3, colour = "blue", linetype = "dashed") +
geom_hline(yintercept = 0.5, colour = "red", linetype = "dashed") +
geom_hline(yintercept = 0.7, colour = "purple", linetype = "dashed") +
labs(
x = "Glucose",
y = "Predicted probability of diabetes",
title = "Predicted probabilities with threshold lines"
) +
theme_minimal()
table(True = prediction_pima$diabetes_dummy, Predicted = prediction_pima$class_0.3)
View(prediction_pima)
ggplot(prediction_pima, aes(x = glucose, y = prob, fill = diabetes)) +
geom_point(alpha = 0.4) +
geom_hline(yintercept = 0.3, colour = "blue", linetype = "dashed") +
geom_hline(yintercept = 0.5, colour = "red", linetype = "dashed") +
geom_hline(yintercept = 0.7, colour = "purple", linetype = "dashed") +
labs(
x = "Glucose",
y = "Predicted probability of diabetes",
title = "Predicted probabilities with threshold lines"
) +
theme_minimal()
ggplot(prediction_pima, aes(x = glucose, y = prob, colour = diabetes)) +
geom_point(alpha = 0.4) +
geom_hline(yintercept = 0.3, colour = "blue", linetype = "dashed") +
geom_hline(yintercept = 0.5, colour = "red", linetype = "dashed") +
geom_hline(yintercept = 0.7, colour = "purple", linetype = "dashed") +
labs(
x = "Glucose",
y = "Predicted probability of diabetes",
title = "Predicted probabilities with threshold lines"
) +
theme_minimal()
ggplot(prediction_pima, aes(x = glucose, y = prob, colour = diabetes)) +
geom_point() +
geom_hline(yintercept = 0.3, colour = "blue", linetype = "dashed") +
geom_hline(yintercept = 0.5, colour = "red", linetype = "dashed") +
geom_hline(yintercept = 0.7, colour = "purple", linetype = "dashed") +
labs(
x = "Glucose",
y = "Predicted probability of diabetes",
title = "Predicted probabilities with threshold lines"
) +
theme_minimal()
ggplot(prediction_pima, aes(x = glucose, y = prob, colour = diabetes)) +
geom_point(size = 2, alpha = 0.7) +
geom_hline(yintercept = 0.3, colour = "blue", linetype = "dashed") +
geom_hline(yintercept = 0.5, colour = "red", linetype = "dashed") +
geom_hline(yintercept = 0.7, colour = "purple", linetype = "dashed") +
labs(
x = "Glucose",
y = "Predicted probability of diabetes",
title = "Predicted probabilities with threshold lines"
) +
theme_minimal()
table(True = prediction_pima$diabetes_dummy, Predicted = prediction_pima$class_0.3)
table(True = prediction_pima$diabetes, Predicted = prediction_pima$class_0.3)
table(True = prediction_pima$diabetes_dummy, Predicted = prediction_pima$class_0.3)
table(True = pima$diabetes_dummy, Predicted = pima$class_0.5)
table(True = prediction_pima$diabetes_dummy, Predicted = prediction_pima$class_0.5)
table(True = prediction_pima$diabetes_dummy, Predicted = prediction_pima$class_0.7)
threshold_compare <- tibble(
threshold = c("0.3", "0.5", "0.7"),
TP = c(
sum(prediction_pima$diabetes_dummy == 1 & prediction_pima$class_0.3 == 1),
sum(prediction_pima$diabetes_dummy == 1 & prediction_pima$class_0.5 == 1),
sum(prediction_pima$diabetes_dummy == 1 & prediction_pima$class_0.7 == 1)
),
FP = c(
sum(prediction_pima$diabetes_dummy == 0 & prediction_pima$class_0.3 == 1),
sum(prediction_pima$diabetes_dummy == 0 & prediction_pima$class_0.5 == 1),
sum(prediction_pima$diabetes_dummy == 0 & prediction_pima$class_0.7 == 1)
),
FN = c(
sum(prediction_pima$diabetes_dummy == 1 & prediction_pima$class_0.3 == 0),
sum(prediction_pima$diabetes_dummy == 1 & prediction_pima$class_0.5 == 0),
sum(prediction_pima$diabetes_dummy == 1 & prediction_pima$class_0.7 == 0)
),
TN = c(
sum(prediction_pima$diabetes_dummy == 0 & prediction_pima$class_0.3 == 0),
sum(prediction_pima$diabetes_dummy == 0 & prediction_pima$class_0.5 == 0),
sum(prediction_pima$diabetes_dummy == 0 & prediction_pima$class_0.7 == 0)
)
)
threshold_compare
knitr::include_graphics("https://share.google/images/qk1gABTY4pvZVzcu3")
knitr::include_graphics("https://iq.opengenus.org/content/images/2021/11/summary.png")
threshold_metrics <- threshold_compare %>%
mutate(
Sensitivity = round(TP / (TP + FN), 3),
Specificity = round(TN / (TN + FP), 3)
)
threshold_metrics
prediction_pima <-
predict(log_fit, new_data = pima[1:20,], type = "prob") %>%
rename(prob = .pred_pos)  %>%
dplyr::bind_cols(pima[1:20,])
head(pima)
prediction_pima <- prediction_pima %>%
mutate(
class_0.3 = if_else(prob >= 0.3, 1, 0),
class_0.5 = if_else(prob >= 0.5, 1, 0),
class_0.7 = if_else(prob >= 0.7, 1, 0)
)
ggplot(prediction_pima, aes(x = glucose, y = prob, colour = diabetes)) +
geom_point(size = 2, alpha = 0.7) +
geom_hline(yintercept = 0.3, colour = "blue", linetype = "dashed") +
geom_hline(yintercept = 0.5, colour = "red", linetype = "dashed") +
geom_hline(yintercept = 0.7, colour = "purple", linetype = "dashed") +
labs(
x = "Glucose",
y = "Predicted probability of diabetes",
title = "Predicted probabilities with threshold lines"
) +
theme_minimal()
table(True = prediction_pima$diabetes_dummy, Predicted = prediction_pima$class_0.3)
table(True = prediction_pima$diabetes_dummy, Predicted = prediction_pima$class_0.5)
table(True = prediction_pima$diabetes_dummy, Predicted = prediction_pima$class_0.7)
threshold_compare <- tibble(
threshold = c("0.3", "0.5", "0.7"),
TP = c(
sum(prediction_pima$diabetes_dummy == 1 & prediction_pima$class_0.3 == 1),
sum(prediction_pima$diabetes_dummy == 1 & prediction_pima$class_0.5 == 1),
sum(prediction_pima$diabetes_dummy == 1 & prediction_pima$class_0.7 == 1)
),
FP = c(
sum(prediction_pima$diabetes_dummy == 0 & prediction_pima$class_0.3 == 1),
sum(prediction_pima$diabetes_dummy == 0 & prediction_pima$class_0.5 == 1),
sum(prediction_pima$diabetes_dummy == 0 & prediction_pima$class_0.7 == 1)
),
FN = c(
sum(prediction_pima$diabetes_dummy == 1 & prediction_pima$class_0.3 == 0),
sum(prediction_pima$diabetes_dummy == 1 & prediction_pima$class_0.5 == 0),
sum(prediction_pima$diabetes_dummy == 1 & prediction_pima$class_0.7 == 0)
),
TN = c(
sum(prediction_pima$diabetes_dummy == 0 & prediction_pima$class_0.3 == 0),
sum(prediction_pima$diabetes_dummy == 0 & prediction_pima$class_0.5 == 0),
sum(prediction_pima$diabetes_dummy == 0 & prediction_pima$class_0.7 == 0)
)
)
threshold_compare
knitr::include_graphics("https://iq.opengenus.org/content/images/2021/11/summary.png")
threshold_metrics <- threshold_compare %>%
mutate(
Sensitivity = round(TP / (TP + FN), 3),
Specificity = round(TN / (TN + FP), 3)
)
threshold_metrics
library(mlbench)
library(tidyverse)
library(tidymodels)
data("PimaIndiansDiabetes")
pima <- PimaIndiansDiabetes %>%
select(glucose, diabetes) %>%
mutate(
diabetes = fct_relevel(diabetes, "pos"),
diabetes_dummy = if_else(diabetes == "pos", 1, 0)
)
log_spec <-
logistic_reg(mode = "classification") %>%
set_engine("glm")
log_fit <-
log_spec %>%
fit(diabetes ~ glucose, data = pima)
tidy(log_fit)
prediction_pima <-
predict(log_fit, new_data = pima[1:15,], type = "prob") %>%
rename(prob = .pred_pos)  %>%
dplyr::bind_cols(pima[1:15,])
head(pima)
prediction_pima <- prediction_pima %>%
mutate(
class_0.3 = if_else(prob >= 0.3, 1, 0),
class_0.5 = if_else(prob >= 0.5, 1, 0),
class_0.7 = if_else(prob >= 0.7, 1, 0)
)
ggplot(prediction_pima, aes(x = glucose, y = prob, colour = diabetes)) +
geom_point(size = 2, alpha = 0.7) +
geom_hline(yintercept = 0.3, colour = "blue", linetype = "dashed") +
geom_hline(yintercept = 0.5, colour = "red", linetype = "dashed") +
geom_hline(yintercept = 0.7, colour = "purple", linetype = "dashed") +
labs(
x = "Glucose",
y = "Predicted probability of diabetes",
title = "Predicted probabilities with threshold lines"
) +
theme_minimal()
table(True = prediction_pima$diabetes_dummy, Predicted = prediction_pima$class_0.3)
table(True = prediction_pima$diabetes_dummy, Predicted = prediction_pima$class_0.5)
table(True = prediction_pima$diabetes_dummy, Predicted = prediction_pima$class_0.7)
threshold_compare <- tibble(
threshold = c("0.3", "0.5", "0.7"),
TP = c(
sum(prediction_pima$diabetes_dummy == 1 & prediction_pima$class_0.3 == 1),
sum(prediction_pima$diabetes_dummy == 1 & prediction_pima$class_0.5 == 1),
sum(prediction_pima$diabetes_dummy == 1 & prediction_pima$class_0.7 == 1)
),
FP = c(
sum(prediction_pima$diabetes_dummy == 0 & prediction_pima$class_0.3 == 1),
sum(prediction_pima$diabetes_dummy == 0 & prediction_pima$class_0.5 == 1),
sum(prediction_pima$diabetes_dummy == 0 & prediction_pima$class_0.7 == 1)
),
FN = c(
sum(prediction_pima$diabetes_dummy == 1 & prediction_pima$class_0.3 == 0),
sum(prediction_pima$diabetes_dummy == 1 & prediction_pima$class_0.5 == 0),
sum(prediction_pima$diabetes_dummy == 1 & prediction_pima$class_0.7 == 0)
),
TN = c(
sum(prediction_pima$diabetes_dummy == 0 & prediction_pima$class_0.3 == 0),
sum(prediction_pima$diabetes_dummy == 0 & prediction_pima$class_0.5 == 0),
sum(prediction_pima$diabetes_dummy == 0 & prediction_pima$class_0.7 == 0)
)
)
threshold_compare
knitr::include_graphics("https://iq.opengenus.org/content/images/2021/11/summary.png")
threshold_metrics <- threshold_compare %>%
mutate(
Sensitivity = round(TP / (TP + FN), 3),
Specificity = round(TN / (TN + FP), 3)
)
threshold_metrics
# Load necessary libraries
library(ggplot2)
library(tidymodels)
library(ConfusionTableR) #probably will need to install it
# Example data with predicted probabilities
set.seed(123)
actual <- factor(sample(c("pos", "neg"), 20, replace = TRUE, prob = c(0.5, 0.5)))
predicted_prob <- runif(20) # Simulated predicted probabilities
# Adjust threshold and classify
threshold <- 0.5
predicted <- factor(ifelse(predicted_prob >= threshold, "pos", "neg"))
data <- data.frame(actual = actual, predicted = predicted)
cm <- data %>%
conf_mat(truth = actual, estimate = predicted)
cm
autoplot(cm, type = "heatmap")
ConfusionTableR::binary_visualiseR(train_labels = predicted,
truth_labels= actual,
class_label1 = "Negative",
class_label2 = "Positive",
quadrant_col1 = "#28ACB4",
quadrant_col2 = "#4397D2",
custom_title = "Diabetes Confusion Matrix",
text_col= "black")
View(prediction_pima)
data <- data.frame(actual = prediction_pima$diabetes_dummy, predicted = prediction_pima$class_0.7)
cm <- data %>%
conf_mat(truth = actual, estimate = predicted)
str(prediction_pima)
#Set as factors the required columns:
prediction_pima$diabetes_dummy <- as.factor(prediction_pima$diabetes_dummy)
prediction_pima$class_0.7 <- as.factor(prediction_pima$class_0.7)
data <- data.frame(actual = prediction_pima$diabetes_dummy, predicted = prediction_pima$class_0.7)
cm <- data %>%
conf_mat(truth = actual, estimate = predicted)
cm
autoplot(cm, type = "heatmap")
pima_preds_glucose <-
predict(logistic_fit_glucose, new_data = pima, type = "prob") %>%
# type = "prob" gives a column for each class probability
rename(prob_pos = .pred_pos, prob_neg = .pred_neg)
pima_preds_glucose <-
predict(logistic_fit_glucose, new_data = pima, type = "prob") %>% # type = "prob" gives a column for each class probability
rename(prob_pos = .pred_pos, prob_neg = .pred_neg)
#| label: prob-odds-logodds
# Define the probability of success
prob <- 0.8
cat(sprintf("Probability: %.2f\n", prob))
# Convert probability to odds
odds <- prob / (1 - prob)
cat(sprintf("Odds: %.2f\n", odds))
# Convert odds to log-odds (logit)
log_odds <- log(odds)
cat(sprintf("Log-odds: %.2f\n", log_odds))
#| label: load-data
library(mlbench)
library(tidyverse)
library(tidymodels)
data("PimaIndiansDiabetes")
pima <- PimaIndiansDiabetes %>%
select(glucose, diabetes, mass, age)
glimpse(pima)
#| label: class-balance
pima %>%
count(diabetes)
#| label: relevel-outcome
pima <- pima %>%
mutate(diabetes = fct_relevel(diabetes, "pos"))
pima |>
count(diabetes)
#| label: specify-model-1
logistic_spec <-
logistic_reg(mode = "classification") %>%
set_engine("glm")
logistic_spec
#| label: fit-model-1
logistic_fit_glucose <-
logistic_spec %>%
fit(diabetes ~ glucose, data = pima)
logistic_fit_glucose
#| label: coef-model-1
tidy(logistic_fit_glucose)
#| label: odds-example
coefs <- tidy(logistic_fit_glucose)
#This is the same as in yesterday's practical doing logistic_fit_glucose[["fit]][["coefficients]]
intercept <- coefs$estimate[coefs$term == "(Intercept)"]
slope     <- coefs$estimate[coefs$term == "glucose"]
glucose_value <- 120
log_odds_120 <- intercept + slope * glucose_value    # linear predictor z
odds_120     <- exp(log_odds_120)                    # odds
prob_120     <- 1 / (1 + exp(-log_odds_120))         # probability
cat("Log-odds at glucose = 120:", round(log_odds_120, 3), "\n")
cat("Odds at glucose = 120    :", round(odds_120, 3), "\n")
cat("Probability at glucose = 120:", round(prob_120, 3), "\n")
pima_preds_glucose <-
predict(logistic_fit_glucose, new_data = pima, type = "prob") %>% # type = "prob" gives a column for each class probability
rename(prob_pos = .pred_pos, prob_neg = .pred_neg)
pima_preds_glucose %>%
select(glucose, diabetes, prob_pos, prob_neg) %>%
head()
pima_preds_glucose <-
predict(logistic_fit_glucose, new_data = pima, type = "prob") %>% # type = "prob" gives a column for each class probability
rename(prob_pos = .pred_pos, prob_neg = .pred_neg) %>%
dplyr::bind_cols(pima)
pima_preds_glucose %>%
select(glucose, diabetes, prob_pos, prob_neg) %>%
head()
#| label: plot-prob-vs-glucose
ggplot(pima_preds_glucose, aes(x = glucose, y = prob_pos)) +
geom_point(alpha = 0.4) +
geom_smooth(method = "loess", se = FALSE) +
labs(
x = "Glucose",
y = "Predicted probability of diabetes (pos)"
) +
theme_minimal()
#| label: plot-observed-vs-prob
pima_preds_glucose %>%
mutate(diabetes_numeric = if_else(diabetes == "pos", 1, 0)) |>
ggplot(aes(x = glucose)) +
geom_point(aes(y = diabetes_numeric), alpha = 0.4) +
geom_line(aes(y = prob_pos), colour = "red", linewidth = 1) +
scale_y_continuous(breaks = c(0, 0.5, 1), limits = c(-0.05, 1.05)) +
labs(
x = "Glucose",
y = "Observed class (0/1) and predicted probability"
) +
theme_minimal()
library(reticulate)
# one-off setup (if you haven't done it yet)
# install_miniconda()
##conda_create(
##  envname = "hds-python",
##  python_version = "3.11",
##  packages = c("numpy", "pandas", "matplotlib", "seaborn", "scikit-learn")
##)
use_condaenv("hds-python", required = TRUE)
#py_config()
#conda_install("hds-python", c("jupyter", "plotly"))
#R
library(tidymodels)
log_spec   <- logistic_reg(mode = "classification")
tree_spec  <- decision_tree(mode = "classification")
rf_spec    <- rand_forest(mode = "regression")
knn_spec   <- nearest_neighbor(mode = "classification")
log_spec
tree_spec
#R
log_spec_glm <- logistic_reg(mode = "classification") |>
set_engine("glm")      # uses base R glm() with binomial family
log_spec_glmnet <- logistic_reg(mode = "classification") |>
set_engine("glmnet")   # uses penalised regression (elastic net)
tree_spec_rpart <- decision_tree(mode = "classification") |>
set_engine("rpart")    # uses rpart (CART)
boost_spec_xgb <- boost_tree(mode = "classification") |>
set_engine("xgboost")  # uses xgboost library
#R
library(mlbench)
data("PimaIndiansDiabetes")
pima <- PimaIndiansDiabetes %>%
dplyr::select(glucose, mass, age, diabetes) %>%
# we want "pos" (diabetes present) as the event of interest
dplyr::mutate(diabetes = forcats::fct_relevel(diabetes, "pos")) # here we are saying that what we are trying to predict (i=our positive, 1 class is "pos")
split <- initial_split(pima, prop = 0.8, strata = diabetes)
pima_train <- training(split)
pima_test  <- testing(split)
# Model spec + engine
logistic_spec <-
logistic_reg(mode = "classification") |>
set_engine("glm")   # internally: glm(..., family = binomial)
#R
logistic_fit <-
logistic_spec %>%
fit(diabetes ~ glucose, data = pima_train)
logistic_fit
#R
tidy(logistic_fit)
#R
pima_preds <-
predict(logistic_fit, new_data = pima_test, type = "prob") %>%
dplyr::bind_cols(pima_test)
head(pima_preds)
#R
library(ggplot2)
ggplot(pima_preds, aes(x = glucose, y = .pred_pos)) +
geom_point(alpha = 0.4) +
labs(
x = "Glucose",
y = "Predicted probability of diabetes (pos)"
) +
theme_minimal()
#R
log_recipe <-
recipe(diabetes ~ glucose + age + mass, data = pima) |>
step_normalize(all_numeric_predictors())
log_workflow <-
workflow() |>
add_model(logistic_spec) |>
add_recipe(log_recipe)
log_fit_multi <- fit(log_workflow, data = pima)
log_fit_multi
reticulate::repl_python()
#Python
log_recipe <-
recipe(diabetes ~ glucose + age + mass, data = pima) |>
step_normalize(all_numeric_predictors())
logistic_spec <-
logistic_reg(mode = "classification") |>
set_engine("glm")
log_workflow <-
workflow() |>
add_model(logistic_spec) |>
add_recipe(log_recipe)
log_fit_multi <- fit(log_workflow, data = pima)
reticulate::repl_python()
